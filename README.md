## Coinsight DB

### 1.	프로젝트 개요

제안하는 ‘Coinsight’ 프로젝트는 코인 시장의 변동성과 커뮤니티 반응을 실시간으로 분석하여 사용자에게 한눈에 알아볼 수 있도록 정보를 제공하는 데이터베이스 시스템이다. 

코인의 Coin, 통찰력의 insight를 합쳐 Coinsight로 코인의 움직임에 숨겨진 통찰을 발견하고자 하는 이름으로 정하였다. 
이때까지 제시된 코인 시세 확인 사이트에서는 가격 정보와 기술적 지표만 제시하였지, 실시간적인 시세 동향의 반응을 같이 확인하기 어려워 그래프 따로, 커뮤니티, 카톡방 등 따로 띄워두고 일일히 가격 움직임을 수동으로 포착하고 특이 움직임에 대한 거래자들 반응을 살피는 수고가 있었다.
가장 유명한 코인 시세 사이트인 코인마켓캡을 예시로 제시하겠다.

![image](https://github.com/user-attachments/assets/7f1ac811-a23c-4ed7-b262-d7214398b5af)

해당 그림을 보면, 코인 정보 및 시세와 사이트 내 투표를 이용한 Community Sentiment와 X(구 트위터)에서 해당 코인 정보를 필터링 하여 제시한다.
하지만 어느 시간대에 그러한 글이 올라왔고 소식이 있었는지, 글들의 내용이 아닌 투표 기반으로 Sentiment를 측정해 정보를 찾아보기 어렵고 신뢰성이 의심된다.
따라서, 코인 그래프를 제시함과 동시에 원하는 지점 선택 시, 해당 시간대의 커뮤니티 반응이 동시에 나타나고 각 지점의 커뮤니티 활성도(반응 수) 등의 통계를 제시할 수 있어 더욱 시세 파악이 명확한 데이터베이스를 구축하는 것에 목적이 있다. 
평소부터 코인 시세에 관심이 많았지만, 24시간동안 각 시간대별로 오르내리는 뉴스와 트렌드 파악에 체력적으로 부담이 되어 많은 시간을 쏟을 수 없었던 점이 아쉬워 해당 프로그램을 생각하게 되었다.
1인 프로젝트라, 기본적으로 Python만을 이용하여 진행할 예정이다. 기반 데이터베이스는 PostgreSQL을 사용한다.

### Database ERD

![image](https://github.com/user-attachments/assets/432dea23-ffeb-4b30-8eae-3e1d96a63a7d)


### 2.	사용자 (역할)

#### 	Database Administrator (관리자)

데이터베이스 관리와 보안 설정을 담당하며, 모든 테이블에 대한 접근 권한이 있다. DML(Data Manipulation Language) 모든 데이터를 조회, 삽입, 삭제, 업데이트할 수 있고, DDL(Data Definition Language): 테이블 생성, 수정, 삭제 권한이 있다.

#### 	Data Collector (데이터 수집기)

외부 API와 커뮤니티에서 데이터를 수집해 데이터베이스에 저장한다. 바이낸스 api를 이용해 OHLCV데이터를 수집하고, Telerecon 라이브러리를 이용해 텔레그램 채팅 데이터를 수집하여 데이터베이스에 저장한다.
데이터 접근 권한은 Coin_OHLCV, Community_Reactions 테이블에 대한 삽입 권한과 최소한의 조회 권한만 존재한다.

#### 	Data Scheduler (데이터 스케줄러)

데이터의 통계적 뷰 생성과 관리, 일정 주기가 지난 데이터를 수집, 보관 및 아카이빙하는 역할이다.

주기적인 뷰 갱신

최신 OHLCV 데이터와 커뮤니티 반응을 특정 시간 단위로 업데이트하여 빠르게 제공할 수 있게 Materialized View로 데이터를 제공한다.

주기적인 집계 및 필터링 뷰

일별 혹은 주별로 코인의 평균 가격과 커뮤니티의 반응을 집계하는 뷰로, 특정 시간대에 대한 데이터를 집계하거나 필터링된 데이터를 보여주는 뷰를 생성하여 사용자에게 주요 정보를 빠르게 제공한다.

성능 최적화

주기적으로 수집된 데이터에 대해 인덱스 및 파티셔닝을 적용하여 대용량 데이터를 빠르게 조회할 수 있도록 최적화한다.

아카이빙

주 테이블에서 일정 기간이 지난 데이터를 보관한다. 
접근 권한은 데이터 조회를 위한 SELECT, 뷰를 위한 REFRESH, 최적화를 위한 인덱스 생성 권한 등이 있다.

#### 	End User (사용자) 

OHLCV 시계열 데이터 조회 및 커뮤니티 반응을 확인한다. 특정 시간대, 코인 또는 키워드에 따라 데이터 필터링. JOIN과 WHERE 조건을 통해 필요한 데이터만 조회 가능하고, 사용자 화면에 표시될 데이터의 양을 조절하고, 정렬된 결과를 제공한다. 읽기 전용 접근 권한만 허용하여 데이터 변경을 방지한다.


### 3. 기능

초반 제안서에서는 프론트엔드도 구성하고, 커뮤니티 반응에 대한 실시간 분석을 지원하려 했는데 분석할 대상이 30만개가 넘어서 데이터 수집에도, 분석에도 너무 오랜 시간이 걸려 커뮤니티 데이터와 분석 데이터는 10월 1일부터 11월 24일까지의 데이터만 탑재할 수 있었다. 

시간이 부족하여 각 역할군에 맞는 수집기, 스케줄러, 데이터베이스만 구현하였다. 모든 데이터 수집기에는 트랜잭션을 통한 데이터 안정성을 보장한다.
Coinsight는 코인의 시세 변동과 이에 대한 커뮤니티 반응을 실시간으로 분석하여 사용자에게 통찰력 있는 정보를 제공하는 데이터베이스이다. 기존의 코인 시세 확인 사이트들은 가격 정보와 기술적 지표만을 제공하는 반면, Coinsight는 커뮤니티의 반응과 그에 따른 감정 상태를 함께 제시하여 사용자가 더 나은 의사 결정을 할 수 있도록 돕는다.

#### 3-1. 코인 정보 조회 기능
사용자가 코인 정보를 조회할 수 있는 기능이다. 

SELECT로 코인 메타데이터를 조회하고, JOIN으로 다른 테이블(Coin_OHLCV, Community_Reactions)과 연계하여 특정 코인에 대한 데이터를 종합한다. 조건에 따른 정렬(Sorting), 예를 들어 시가총액 기준으로 코인 순서 설정, 필터링(Filtering) 조회가 가능하다. 업비트의 모든 KRW 거래화폐쌍 146종을 지원하고, 코인마켓캡API, 코인파프리카API를 이용하여 시총뿐만 아니라, 총 유통량, 현재 유통량, 랭킹, 24시간 시총 변화, 설명등의 추가 메타데이터를 확인할 수 있다.
새로운 코인이 추가되거나 갱신될 때 같이 연동하여 변한다.

![image](https://github.com/user-attachments/assets/491f3046-3401-4347-8aa7-edae47b5c786)

#### 3-2. 시세 조회 및 시간별 분석 기능
코인의 OHLCV 데이터를 시간대별로 조회하여 시세 변동과 거래량을 분석할 수 있는 기능이다.

SELECT로 시간대별 코인 시세 및 거래량을 조회할 수 있는데, 10월 1일부터 현재까지 146종 코인들의 1시간봉 데이터를 가져왔다. 처음엔 5분봉의 데이터를 사용할 예정이었으나 1개 코인당 2달치의 데이터가 너무 크고 수집API의 Rate Limit으로 많이 수집할 수 없어 1시간봉 데이터를 수집하게 되었다. 총 243,251건의 데이터로 이루어져 있고 원하는 시간대, 코인을 선택하여 볼 수 있다.

![image](https://github.com/user-attachments/assets/8c709ea4-4787-4caf-bc3e-7a1dbb230078)

#### 3-3. 커뮤니티 반응 조회 기능
사용자가 코인의 가격 타임스탬프에서 특정 시간대를 선택하면, 그 시간대에 해당하는 커뮤니티 반응을 함께 표시한다. 

이는 Coin_OHLCV 테이블의 시세 데이터와 Community_Reactions 테이블의 커뮤니티 반응 데이터를 연동하여 실시간으로 조회할 수 있도록 구현되었다. 반응 데이터가 시간상 한계로 전체를 수집하지 못한 것 뿐이지, 실시간 업데이트 기능과 데이터베이스 구성은 완료되어 있다.
SELECT 및 JOIN으로 커뮤니티 반응과 코인 가격을 함께 조회할 수 있도록 한다. 
시간대별 반응 수 기반 정렬로 어느 시간대에 가장 활발하게 사람들이 활동했는지 제시한다. 
기존에 커뮤니티 데이터 수집을 위해 텔레그램의 데이터를 이용하려고 결정하였는데, 커스텀 봇을 채팅방에 넣고 계속해서 탐지하고 채팅을 수집할 수도 있지만, 해당 채팅방에 봇이 들어간 이후부터 데이터가 수집되기 때문에 이전 데이터를 수집하기 위해 전용 수집 라이브러리인 Telerecon을 사용하였다.
Telerecon은 Telegram을 연구, 조사 및 스크래핑하기 위한 포괄적인 OSINT 정찰 프레임워크이다. 일반적인 인터넷 커뮤니티도 수집하려고 했지만, 크롤링 방지 정책에 의해 IP가 계속 차단당하여 실패하였다.
수집 대상 커뮤니티는 2024년 11월 24일 기준, 2024년 10월 1일부터 활성 채팅수가 1만개 이상인 채팅방들을 대상으로 데이터 수집을 진행하였다.
커뮤니티 채팅방 뿐만 아니라 공신력 있는 뉴스나, 최신 암호화폐 소식을 들고오는 뉴스 채널도 3개를 포함하여 뉴스 데이터만 볼 수 있게 하였다.
결과적으로는 총 13개 채널을 선정하여 2024년 10월 1일부터 11월 24일까지 395,301개의 커뮤니티 채팅 데이터를 수집하였다.

![image](https://github.com/user-attachments/assets/5a95bb80-1d8b-4fe8-bd33-39886074e183)


#### 3-4. 감정 분석 및 텍스트 분석
커뮤니티 반응에서 추출한 명사, 형용사, 동사, 감탄사를 분석하여 Community_Analysis 테이블에 캐싱한다. 이 데이터와 함께 커뮤니티의 감정 상태(긍정적, 부정적, 중립적)를 분석할 수 있다. 

형태소 분석은 nltk 라이브러리의 구 트위터 형태소 분석기인 OKT를 이용하였고 감정 분석은 한국어 금융 파인튜닝 감정 분류 모델인 KR-FinBert-SC 모델을 이용하였다. 컴퓨터에 GPU가 없어 CPU로 실행하고 부담을 낮추기 위해 정밀도 조정, 모델 최적화를 진행하였다. 각 데이터의 처리가 오래 걸리므로 배치 단위 트랜잭션을 적용하였다.

![image](https://github.com/user-attachments/assets/c7388219-2a94-4265-b02b-8ff88f6edd18)


#### 3-4. 추천 및 알림 기능
Recommendations 테이블을 통해 사용자는 실시간으로 추천된 코인을 확인할 수 있다. 변동성이 크거나 커뮤니티에 많이 언급되는 코인을 추천해주는 기능이다. 

분석 데이터를 기반으로 알림 메시지를 생성한다. 기본적으로 3일 단위의 슬라이싱 윈도우로 언급량의 증가, 감소를 통해 코인을 추천하게 된다.
특정 추천 기준에 따른 코인 필터링과 정렬 및 조건 필터링을 통해 사용자에게 적합한 코인 추천이 가능하다. 커뮤니티 분석 테이블의 정보에서 코인 이야기만을 필터링하고 특정 코인과 다대다 관계를 만들어주는 식으로 연관관계를 구성하였다.

![image](https://github.com/user-attachments/assets/efafc782-98c8-4afe-b022-1cbd380ee9fb)

![image](https://github.com/user-attachments/assets/b97b2bbd-788a-46b7-96d6-d88e38819aee)

### 4. 특징
#### •	PARTITION BY RANGE 사용
Coin_OHLCV, Community_Reactions, Community_Analysis 테이블 모두 시간대별로 RANGE 파티셔닝을 적용하였다. 이는 대용량 데이터를 다룰 때 효율적으로 데이터를 분할하고, 특정 시간대의 데이터만 빠르게 조회할 수 있도록 돕는다. 이렇게 파티셔닝된 테이블은 데이터가 자동으로 날짜별로 분리되며, 시간 범위에 맞는 데이터를 효율적으로 관리한다.

#### •	FOREIGN KEY와 ON DELETE CASCADE
Community_Reactions, Community_Analysis, Community_Analysis_Coins, Recommendations 등 여러 테이블에서 외래 키(FOREIGN KEY) 제약 조건을 사용하였다. 이로 인해, 관련된 코인 데이터나 반응 데이터가 삭제되면 연관된 데이터들도 자동으로 삭제되는 ON DELETE CASCADE 옵션이 적용되어 데이터 무결성을 보장한다.

#### •	복합 인덱스와 단일 인덱스 활용
Coin_OHLCV 테이블에서는 coin_id와 timestamp의 복합 인덱스를 생성하여 시간대별로 특정 코인에 대한 시세 데이터를 빠르게 조회할 수 있다. 또한, Community_Reactions 테이블에서는 timestamp와 chat_name, sender, source 등의 필드에 복합 인덱스를 추가하여 커뮤니티 데이터를 효율적으로 검색할 수 있다. 

#### •	md5() 해시 인덱스
커뮤니티 반응의 긴 텍스트 데이터를 탑재할 때 성능을 최적화하기 위해 md5(reaction_text)에 대한 인덱스를 생성하여 반응 내용의 중복을 빠르게 확인할 수 있다. 텍스트 분석을 빠르게 처리하는 데 유용하다.

#### •	SELECT partman.create_parent를 통한 파티셔닝 자동화
partman 확장을 도입하여 테이블의 파티셔닝을 자동으로 관리한다. 이 SQL 구문을 통해 파티션을 생성하고, 특정 기간의 데이터를 유지하며 새로운 파티션을 자동으로 추가할 수 있다. 또한 partman 파티셔닝 설정을 업데이트하여 데이터 보존 기간을 설정하고, 특정 기간 이후 데이터를 자동으로 삭제하도록 한다. 예를 들어, coin_ohlcv 테이블에 대해 3개월 동안 데이터를 유지하고, 이후에는 자동으로 삭제되도록 설정되었다.

#### •	PG_cron 도입으로 유지보수 자동화
위의 partman과 연동하여 주기적으로 실행되어야 하는 것들은 파이썬 스케줄러 말고도 데이터베이스 내부에서 실행할 수 있게 pg_cron을 이용하여 자동화하였다. 예를 들어 1일마다 각 파티션의 상태를 점검하고 새로 필요할 경우 자동으로 생성하거나 제거하도록 한다.

#### View와 Meterialized View 
자주 조회될 수 있지만 여러 테이블과 많은 데이터를 조회하게 되는 하루의 코인 통계 조회 기능은 Meterialized View로 구현하여 조회가 빠르게 캐싱되도록하였고, 빠른 변화와 실시간성이 필요한 추천정보 테이블은 복잡한 쿼리이지만 간단하게 조회할 수 있도록 View로 구현하였다.

![image](https://github.com/user-attachments/assets/84d8efbf-8b6c-4101-84c9-7823ba74defc)

![image](https://github.com/user-attachments/assets/f005f596-db85-454f-becc-ae189b8844ac)

추천 테이블을 보면 해당 기간에 가장 높은 가격 상승률을 보여준 리플이 반응 분석으로 추천된 코인에서도 1위를 보여주고 있다.
